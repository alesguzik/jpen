
<project name="jniBuild" default="linkSrc">

		<import file="javaBuild.xml"/>

		<target name="init" depends="javaBuild.init">
				<!--list of classes with native methods -->
				<property name="module.jniClasses" value="jpen.cFramework.TestType, jpen.provider.xinput.XiBus, jpen.provider.xinput.XiDevice, jpen.provider.wintab.WintabAccess "/>
				<property name="module.linuxGccExtraLib" value="-lXi"/>
				<property name="module.windowsGccExtraLib" value="-Llib -lWintab32"/>
				<property name="module.jniLibName" value="${module.id}-${module.version}"/>

				<!-- TIPS for Windows DLLs

				Todavia no he probado esto!

				* to generate the def and use dlltool see:
				http://www.mingw.org/MinGWiki/index.php/CreateImportLibraries
				use also the "-A" switch in dlltool:
				wine c:/mingw/bin/dlltool -d Wintab32.def -l libWintab32.a
				wine c:/mingw/bin/dlltool -d Wintab32.def -D Wintab32.dll -l libWintab32.a

				*EXAMPLE of using external dll under mingw
				gcc -c -mrtd -Ic:/S/splus6/include VCrndS4.c
				gcc -shared -o S.dll VCrndS4.o -Lc:/S/splus6/lib/mingw -lSqpe

				-->

				<mkdir dir="src/c"/>
				<mkdir dir="src/c/windows"/>
				<mkdir dir="src/c/linux"/>
		</target>

		<target name="linkSrc" depends="javaBuild.linkSrc">
				<exec executable="ln" os="Linux">
						<arg value="-s"/>
						<arg value="-f"/>
						<arg value="src/c"/>
						<arg value="src-c"/>
				</exec>
		</target>

		<target name="clean" depends="javaBuild.clean">
				<delete file="product/lib${module.jniLibName}.so" failonerror="false"/>
				<delete file="product/${module.jniLibName}.dll" failonerror="false"/>
				<delete>
						<fileset dir="src/c/windows" includes="*.o"/>
				</delete>
		</target>

		<target name="javah" depends="init,compile" if="module.jniClasses">
				<javah class="${module.jniClasses}" destdir="src/c" force="yes" classpath="${module.srcclasspath}"></javah>
				<path id="_headers">
						<fileset dir="src/c">
								<include name="*.h"/>
						</fileset>
				</path>
				<pathconvert pathsep="," dirsep="/" property="_cSkeletons" refid="_headers">
						<chainedmapper>
								<mapper type="flatten"/>
								<mapper type="regexp" from="^(.*)\.h$$" to="\1.c"/>
						</chainedmapper>
				</pathconvert>

				<!--<touch>
						<filelist dir="src/c/linux" files="${_cSkeletons}"/>
						<filelist dir="src/c/windows" files="${_cSkeletons}"/>
				</touch>-->
		</target>

		<target name="libLinux" depends="init">
				<pathconvert pathsep=" " dirsep="/" property="_sources">
						<path>
								<fileset dir="src/c/linux" includes="*.c"/>
								<!--<fileset dir="src/c" includes="linux/*.c, all/*.c"/>-->
						</path>
						<!--<mapper type="flatten"/>-->
						<map from="${basedir}/src/c/linux/" to=""/>
				</pathconvert>
				<echo>sources: ${_sources}</echo>
				<!--<exec dir="src/c" executable="gcc" failonerror="true">-->
				<exec dir="src/c/linux" executable="gcc" failonerror="true">
						<arg value="-Wall"/>
						<arg value="-fpic"/>
						<arg value="-shared"/>
						<arg value="-o"/>
						<arg value="lib${module.jniLibName}.so"/>
						<arg line="${module.linuxGccExtraLib}"/>
						<arg line="${_sources}"/>
				</exec>
				<move todir="product" file="src/c/linux/lib${module.jniLibName}.so"/>
				<!--<move todir="product" file="src/c/lib${module.jniLibName}.so"/>-->
		</target>

		<target name="libWin" depends="init">
				<pathconvert pathsep=" " dirsep="/" property="_wsources">
						<path>
								<fileset dir="src/c/windows" includes="*.c" />
						</path>
						<mapper type="flatten"/>
				</pathconvert>
				<echo>sources: ${_wsources}</echo>
				<exec dir="src/c/windows" executable="wine" failonerror="true">
						<arg value="c:\\mingw\\bin\\gcc"/>
						<arg value="-Wall"/>
						<arg value="-c"/>
						<arg value="-mrtd"/>
						<arg value="-D_JNI_IMPLEMENTATION"/>
						<arg value="-Ic:/javaSdk/include"/>
						<arg value="-Ic:/javaSdk/include/win32"/>
						<arg line="${_wsources}"/>
				</exec>

				<pathconvert pathsep=" " dirsep="/" property="_wobjects">
						<path>
								<fileset dir="src/c/windows" includes="*.o" />
						</path>
						<mapper type="flatten"/>
				</pathconvert>
				<exec dir="src/c/windows" executable="wine" failonerror="true">
						<arg value="c:\\mingw\\bin\\gcc"/>
						<arg value="-Wall"/>
						<arg value="-Wl,--kill-at"/>
						<arg value="-shared"/>
						<arg value="-o"/>
						<arg value="${module.jniLibName}.dll"/>
						<arg line="${_wobjects}"/>
						<arg line="${module.windowsGccExtraLib}"/>
				</exec>
				<delete>
						<fileset dir="src/c/windows" includes="*.o"/>
				</delete>
				<move todir="product" file="src/c/windows/${module.jniLibName}.dll"/>
		</target>

		<target name="lib" depends="libLinux, libWin"/>

		<target name="distLib" depends="lib, javaBuild.distLib"/>

		<target name="all" depends="lib, javaBuild.all"/>
		
</project>