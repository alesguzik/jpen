
<project name="jniBuild" default="linkSrc">
	
	<import file="javaBuild.xml"/>
	
	<target name="updateRepoTrunk">
		<exec executable="bash">
			<arg line="-c 'svn up svnRepository/$(readlink svnRepository/current)/trunk'"/>
		</exec>
	</target>
	
	<target name="nativeBuildProperties">
		<exec executable="bash">
			<arg value="nativeBuild.sh"/>
		</exec>
		<property file="nativeBuild.properties"/>
	</target>
	
	<target name="nativeBuildHeaders" depends="nativeBuildProperties">
		<echo file="src/main/c/linux/BuildNumber.h">
/* DO NOT EDIT THIS FILE - it is machine generated */
#ifndef BuildNumber_h
#define BuildNumber_h
#define BUILD_NUMBER ${jpen.provider.xinput.nativeBuild} 
#endif
</echo>
		<echo file="src/main/c/windows/BuildNumber.h">
/* DO NOT EDIT THIS FILE - it is machine generated */
#ifndef BuildNumber_h
#define BuildNumber_h
#define BUILD_NUMBER ${jpen.provider.wintab.nativeBuild}
#endif
</echo>
		<echo file="src/main/c/osx/BuildNumber.h">
/* DO NOT EDIT THIS FILE - it is machine generated */
#ifndef BuildNumber_h
#define BuildNumber_h
#define BUILD_NUMBER ${jpen.provider.osx.nativeBuild}
#endif
</echo>
	</target>
	
	<target name="init" depends="javaBuild.init, nativeBuildProperties, nativeBuildHeaders">
		<!--list of classes with native methods -->
		<property name="module.jniClasses" value="jpen.cFramework.TestType, jpen.provider.xinput.XiBus, jpen.provider.xinput.XiDevice, jpen.provider.wintab.WintabAccess "/>
		<property name="module.linuxGccExtraLib" value="-lXi"/>
		<property name="module.windowsGccExtraLib" value="-Llib -lWintab32 "/>
		<property name="module.windowsGccExtraLib-64" value="-Llib-64 -lWintab64"/>
		<property name="module.jniLibNamePrefix" value="${module.id}-${module.version}"/>
		<property name="jniHeadersPath" value="/opt/sun-jdk-1.5.0.21/include"/>
		
		<property name="module.linuxJniLibName" value="${module.jniLibNamePrefix}-${jpen.provider.xinput.nativeVersion}"/>
		<property name="module.winJniLibName" value="${module.jniLibNamePrefix}-${jpen.provider.wintab.nativeVersion}"/>
		<property name="module.osxJniLibName" value="${module.jniLibNamePrefix}-${jpen.provider.osx.nativeVersion}"/>

				<!-- TIPS for Windows DLLs

				Todavia no he probado esto!

				* to generate the def and use dlltool see:
				http://www.mingw.org/MinGWiki/index.php/CreateImportLibraries
				use also the "-A" switch in dlltool:
				wine c:/mingw/bin/dlltool -d Wintab32.def -l libWintab32.a
				wine c:/mingw/bin/dlltool -d Wintab32.def -D Wintab32.dll -l libWintab32.a

				*EXAMPLE of using external dll under mingw
				gcc -c -mrtd -Ic:/S/splus6/include VCrndS4.c
				gcc -shared -o S.dll VCrndS4.o -Lc:/S/splus6/lib/mingw -lSqpe

				-->
		
		<mkdir dir="src/main/c"/>
		<mkdir dir="src/main/c/windows"/>
		<mkdir dir="src/main/c/linux"/>
	</target>
	
	<target name="linkSrc" depends="javaBuild.linkSrc">
		<exec executable="ln" os="Linux">
			<arg value="-s"/>
			<arg value="-f"/>
			<arg value="src/main/c"/>
			<arg value="src-c"/>
		</exec>
	</target>
	
	<target name="clean" depends="javaBuild.clean">
		<delete>
			<fileset dir="src/main/c/windows" includes="*.o"/>
		</delete>
	</target>
	
	<target name="javah" depends="init,compile" if="module.jniClasses">
		<javah class="${module.jniClasses}" destdir="src/main/c" force="yes" classpath="${module.srcclasspath}"></javah>
		<path id="_headers">
			<fileset dir="src/main/c">
				<include name="*.h"/>
			</fileset>
		</path>
		<pathconvert pathsep="," dirsep="/" property="_cSkeletons" refid="_headers">
			<chainedmapper>
				<mapper type="flatten"/>
				<mapper type="regexp" from="^(.*)\.h$$" to="\1.c"/>
			</chainedmapper>
		</pathconvert>

				<!--<touch>
						<filelist dir="src/main/c/linux" files="${_cSkeletons}"/>
						<filelist dir="src/main/c/windows" files="${_cSkeletons}"/>
				</touch>-->
	</target>
	
	<target name="libLinux-x86" depends="init">
		<pathconvert pathsep=" " dirsep="/" property="_sources">
			<path>
				<fileset dir="src/main/c/linux" includes="*.c"/>
								<!--<fileset dir="src/main/c" includes="linux/*.c, all/*.c"/>-->
			</path>
						<!--<mapper type="flatten"/>-->
			<map from="${basedir}/src/main/c/linux/" to=""/>
		</pathconvert>
		<echo>sources: ${_sources}</echo>
				<!--<exec dir="src/main/c" executable="gcc" failonerror="true">-->
		<exec dir="src/main/c/linux" executable="gcc" failonerror="true">
			<arg value="-Wall"/>
			<arg value="-fpic"/>
			<arg value="-shared"/>
			<arg value="-m32"/>
						<!--<arg value="-nostdinc"/>-->
			<arg value="-o"/>
			<arg value="lib${module.linuxJniLibName}.so"/>
			<arg line="${module.linuxGccExtraLib}"/>
			<arg line="${_sources}"/>
		</exec>
		<move todir="product" file="src/main/c/linux/lib${module.linuxJniLibName}.so"/>
	</target>
	
	<target name="libLinux-x86_64" depends="init">
		<pathconvert pathsep=" " dirsep="/" property="_sources">
			<path>
				<fileset dir="src/main/c/linux" includes="*.c"/>
								<!--<fileset dir="src/main/c" includes="linux/*.c, all/*.c"/>-->
			</path>
						<!--<mapper type="flatten"/>-->
			<map from="${basedir}/src/main/c/linux/" to=""/>
		</pathconvert>
		<echo>sources: ${_sources}</echo>
				<!--<exec dir="src/main/c" executable="gcc" failonerror="true">-->
		<exec dir="src/main/c/linux" executable="x86_64-pc-linux-gnu-gcc" failonerror="true">
			<arg value="-Wall"/>
			<arg value="-fpic"/>
			<arg value="-shared"/>
			<arg value="-I${jniHeadersPath}"/>
			<arg value="-I${jniHeadersPath}/linux"/>
			<arg value="-I/usr/include"/>
			<arg value="-o"/>
			<arg value="lib${module.linuxJniLibName}-x86_64.so"/>
						<!--<arg line="${module.linuxGccExtraLib}"/> underlinked :( -->
			<arg line="${_sources}"/>
		</exec>
		<move todir="product" file="src/main/c/linux/lib${module.linuxJniLibName}-x86_64.so"/>
	</target>
	
	<target name="libLinux-ia64" depends="init">
		<pathconvert pathsep=" " dirsep="/" property="_sources">
			<path>
				<fileset dir="src/main/c/linux" includes="*.c"/>
								<!--<fileset dir="src/main/c" includes="linux/*.c, all/*.c"/>-->
			</path>
						<!--<mapper type="flatten"/>-->
			<map from="${basedir}/src/main/c/linux/" to=""/>
		</pathconvert>
		<echo>sources: ${_sources}</echo>
				<!--<exec dir="src/main/c" executable="gcc" failonerror="true">-->
		<exec dir="src/main/c/linux" executable="ia64-unknown-linux-gnu-gcc" failonerror="true">
			<arg value="-Wall"/>
			<arg value="-fpic"/>
			<arg value="-shared"/>
			<arg value="-I${jniHeadersPath}"/>
			<arg value="-I${jniHeadersPath}/linux"/>
			<arg value="-I/usr/include"/>
			<arg value="-o"/>
			<arg value="lib${module.linuxJniLibName}-ia64.so"/>
						<!--<arg line="${module.linuxGccExtraLib}"/> underlinked :( -->
			<arg line="${_sources}"/>
		</exec>
		<move todir="product" file="src/main/c/linux/lib${module.linuxJniLibName}-ia64.so"/>
	</target>
	
	<target name="libLinux" depends="libLinux-x86, libLinux-x86_64, libLinux-ia64"></target>
	
	<target name="libWin-32" depends="init">
		<pathconvert pathsep=" " dirsep="/" property="_wsources">
			<path>
				<fileset dir="src/main/c/windows" includes="*.c" />
			</path>
			<mapper type="flatten"/>
		</pathconvert>
		<echo>sources: ${_wsources}</echo>
		<exec dir="src/main/c/windows" executable="wine" failonerror="true">
			<arg value="c:\\mingw\\bin\\gcc"/>
			<arg value="-Wall"/>
			<arg value="-c"/>
			<arg value="-mrtd"/>
			<arg value="-D_JNI_IMPLEMENTATION"/>
			<arg value="-Ic:/javaSdk/include"/>
			<arg value="-Ic:/javaSdk/include/win32"/>
			<arg line="${_wsources}"/>
		</exec>
		
		<pathconvert pathsep=" " dirsep="/" property="_wobjects">
			<path>
				<fileset dir="src/main/c/windows" includes="*.o" />
			</path>
			<mapper type="flatten"/>
		</pathconvert>
		<echo>objects: ${_wobjects}</echo>
		<exec dir="src/main/c/windows" executable="wine" failonerror="true">
			<arg value="c:\\mingw\\bin\\gcc"/>
			<arg value="-Wall"/>
			<arg value="-Wl,--kill-at"/>
			<arg value="-shared"/>
			<arg value="-o"/>
			<arg value="${module.winJniLibName}.dll"/>
			<arg line="${_wobjects}"/>
			<arg line="${module.windowsGccExtraLib}"/>
		</exec>
		<delete>
			<fileset dir="src/main/c/windows" includes="*.o"/>
		</delete>
		<move todir="product" file="src/main/c/windows/${module.winJniLibName}.dll"/>
	</target>
	
	<target name="libWin-64" depends="init">
		<pathconvert pathsep=" " dirsep="/" property="_wsources">
			<path>
				<fileset dir="src/main/c/windows" includes="*.c" />
			</path>
			<mapper type="flatten"/>
		</pathconvert>
		<echo>sources: ${_wsources}</echo>
		<exec dir="src/main/c/windows" executable="wine" failonerror="true">
			<arg value="c:\\mingww64\\bin\\x86_64-pc-mingw32-gcc"/>
			<arg value="-Wall"/>
			<arg value="-c"/>
			<arg value="-D_JNI_IMPLEMENTATION"/>
			<arg value="-Ic:/javaSdk/include"/>
			<arg value="-Ic:/javaSdk/include/win32"/>
			<arg line="${_wsources}"/>
		</exec>
		
		<pathconvert pathsep=" " dirsep="/" property="_wobjects">
			<path>
				<fileset dir="src/main/c/windows" includes="*.o" />
			</path>
			<mapper type="flatten"/>
		</pathconvert>
		<echo>objects: ${_wobjects}</echo>
		<exec dir="src/main/c/windows" executable="wine" failonerror="true">
			<arg value="c:\\mingww64\\bin\\x86_64-pc-mingw32-gcc"/>
			<arg value="-Wall"/>
			<arg value="-Wl,--kill-at"/>
			<arg value="-shared"/>
			<arg value="-o"/>
			<arg value="${module.winJniLibName}-64.dll"/>
			<arg line="${_wobjects}"/>
			<arg line="${module.windowsGccExtraLib-64}"/>
		</exec>
		<delete>
			<fileset dir="src/main/c/windows" includes="*.o"/>
		</delete>
		<move todir="product" file="src/main/c/windows/${module.winJniLibName}-64.dll"/>
	</target>
	
	<target name="libWin" depends="libWin-32, libWin-64"></target>
	
	<target name="libOsx" depends="init">
		<copy file="svnRepository/current/trunk/users/marcello3d/osx-build/lib${module.osxJniLibName}.jnilib" toDir="product"/>
	</target>
	
	<target name="lib" depends="libLinux, libWin, libOsx"/>
	
	<target name="all" depends="updateRepoTrunk, lib, javaBuild.all"/>

</project>